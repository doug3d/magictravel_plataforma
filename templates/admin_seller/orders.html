{% extends "admin_seller/base_seller.html" %}

{% block title %}Meus Pedidos{% endblock %}
{% block page_title %}Meus Pedidos{% endblock %}

{% block content %}
<!-- Filtros e A√ß√µes -->
<div class="page-header">
    <div class="filters">
        <select id="statusFilter" class="filter-select">
            <option value="">Todos os Status</option>
            <option value="created">Criados</option>
            <option value="waiting_payment">Aguardando Pagamento</option>
            <option value="paid">Pagos</option>
            <option value="delivered">Entregues</option>
            <option value="cancelled">Cancelados</option>
        </select>
        <button class="btn-refresh" id="refreshBtn">
            üîÑ Atualizar
        </button>
    </div>
    <div class="stats-info">
        <span id="totalOrders">0 pedidos</span>
    </div>
</div>

<!-- Tabela de Pedidos -->
<div class="table-section">
    <div class="table-container">
        <div id="loadingOrders" class="loading-state">
            <div class="spinner-large"></div>
            <p>Carregando pedidos...</p>
        </div>
        
        <div id="emptyOrders" class="empty-state" style="display: none;">
            <div class="empty-icon">üõí</div>
            <p>Nenhum pedido encontrado</p>
            <small>Os pedidos aparecem aqui quando os clientes finalizam suas compras.</small>
        </div>
        
        <table id="ordersTable" style="display: none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>C√≥digo</th>
                    <th>Cliente</th>
                    <th>Status</th>
                    <th>Produtos</th>
                    <th>Total</th>
                    <th>Data</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <!-- Orders will be injected here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Detalhes do Pedido -->
<div id="detailsModal" class="modal" style="display: none;">
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header">
            <div>
                <h2>Detalhes do Pedido</h2>
                <p class="order-info" id="orderInfo"></p>
            </div>
            <button class="modal-close" id="modalClose">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="order-details-grid">
                <!-- Informa√ß√µes do Cliente -->
                <div class="detail-section">
                    <h3>Cliente</h3>
                    <div class="detail-item">
                        <span class="detail-label">Nome:</span>
                        <span id="detailCustomerName">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Email:</span>
                        <span id="detailCustomerEmail">-</span>
                    </div>
                </div>
                
                <!-- Informa√ß√µes do Pedido -->
                <div class="detail-section">
                    <h3>Pedido</h3>
                    <div class="detail-item">
                        <span class="detail-label">C√≥digo:</span>
                        <code id="detailOrderCode">-</code>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span id="detailOrderStatus">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Data:</span>
                        <span id="detailOrderDate">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Produtos -->
            <div class="detail-section full-width">
                <h3>Produtos</h3>
                <table class="products-detail-table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Pre√ßo Unit.</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="detailProductsBody">
                        <!-- Products will be injected here -->
                    </tbody>
                </table>
                <div class="order-total">
                    <strong>Total do Pedido:</strong>
                    <span id="detailOrderTotal" class="total-value">R$ 0,00</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Estado
    let currentFilter = '';
    let allOrders = [];
    
    // Carregar pedidos
    async function loadOrders() {
        const loadingOrders = document.getElementById('loadingOrders');
        const emptyOrders = document.getElementById('emptyOrders');
        const ordersTable = document.getElementById('ordersTable');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const totalOrdersEl = document.getElementById('totalOrders');
        
        try {
            loadingOrders.style.display = 'flex';
            emptyOrders.style.display = 'none';
            ordersTable.style.display = 'none';
            
            const url = currentFilter 
                ? `/seller/admin/api/orders?limit=1000&status=${currentFilter}`
                : '/seller/admin/api/orders?limit=1000';
            
            const data = await window.adminApi.get(url);
            
            allOrders = data.orders || [];
            
            loadingOrders.style.display = 'none';
            
            // Atualizar contador
            totalOrdersEl.textContent = `${allOrders.length} pedido${allOrders.length !== 1 ? 's' : ''}`;
            
            if (allOrders.length === 0) {
                emptyOrders.style.display = 'flex';
                return;
            }
            
            // Renderizar pedidos
            ordersTableBody.innerHTML = allOrders.map(order => `
                <tr>
                    <td>#${order.id}</td>
                    <td><code>${order.code || '-'}</code></td>
                    <td>${order.customer_email}</td>
                    <td><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></td>
                    <td class="products-cell">${order.products}</td>
                    <td class="total-cell">${formatCurrency(order.total)}</td>
                    <td>${formatDate(order.created_at)}</td>
                    <td>
                        <button class="btn-action" onclick="viewOrderDetails(${order.id})" title="Ver detalhes">
                            üëÅÔ∏è
                        </button>
                    </td>
                </tr>
            `).join('');
            
            ordersTable.style.display = 'table';
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            loadingOrders.style.display = 'none';
            emptyOrders.style.display = 'flex';
        }
    }
    
    // Ver detalhes do pedido
    async function viewOrderDetails(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        
        if (!order) {
            alert('Pedido n√£o encontrado');
            return;
        }
        
        // Preencher informa√ß√µes
        document.getElementById('orderInfo').textContent = `Pedido #${order.id}`;
        document.getElementById('detailCustomerName').textContent = order.customer_name || '-';
        document.getElementById('detailCustomerEmail').textContent = order.customer_email;
        document.getElementById('detailOrderCode').textContent = order.code || '-';
        
        const statusBadge = `<span class="status-badge status-${order.status}">${getStatusText(order.status)}</span>`;
        document.getElementById('detailOrderStatus').innerHTML = statusBadge;
        
        document.getElementById('detailOrderDate').textContent = formatDate(order.created_at);
        document.getElementById('detailOrderTotal').textContent = formatCurrency(order.total);
        
        // Parse produtos (vem como string "1x PRODUTO 1, 3x Produto 2")
        const productsStr = order.products;
        const productsHtml = productsStr.split(', ').map(prodStr => {
            const match = prodStr.match(/^(\d+)x (.+)$/);
            if (match) {
                const quantity = parseInt(match[1]);
                const name = match[2];
                // Estimativa de pre√ßo (total / quantidade total de itens)
                return `
                    <tr>
                        <td>${name}</td>
                        <td>${quantity}</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                `;
            }
            return '';
        }).join('');
        
        document.getElementById('detailProductsBody').innerHTML = productsHtml || '<tr><td colspan="4">Sem detalhes de produtos</td></tr>';
        
        // Mostrar modal
        document.getElementById('detailsModal').style.display = 'block';
    }
    
    // Fechar modal
    function closeModal() {
        document.getElementById('detailsModal').style.display = 'none';
    }
    
    // Formata√ß√£o
    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }).format(date);
    }
    
    function getStatusText(status) {
        const statusMap = {
            'created': 'Criado',
            'waiting_payment': 'Aguardando Pagamento',
            'paid': 'Pago',
            'delivered': 'Entregue',
            'cancelled': 'Cancelado'
        };
        return statusMap[status] || status;
    }
    
    // Event listeners
    document.getElementById('statusFilter').addEventListener('change', (e) => {
        currentFilter = e.target.value;
        loadOrders();
    });
    
    document.getElementById('refreshBtn').addEventListener('click', loadOrders);
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalOverlay').addEventListener('click', closeModal);
    
    // Aguardar auth estar pronta
    window.addEventListener('adminAuthReady', () => {
        loadOrders();
    });
</script>

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .filters {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    .filter-select {
        padding: 0.625rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
    }
    
    .stats-info {
        color: #718096;
        font-weight: 500;
    }
    
    .products-cell {
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .total-cell {
        font-weight: 600;
        color: #48bb78;
    }
    
    code {
        background: #f7fafc;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.85rem;
        color: #667eea;
    }
    
    .btn-action {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 1.25rem;
        padding: 0.5rem;
        transition: transform 0.2s;
    }
    
    .btn-action:hover {
        transform: scale(1.2);
    }
    
    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
    }
    
    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
        position: relative;
        background: white;
        max-width: 900px;
        margin: 2rem auto;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-large {
        max-width: 1000px;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .modal-header h2 {
        font-size: 1.5rem;
        color: #2d3748;
        margin-bottom: 0.25rem;
    }
    
    .order-info {
        color: #718096;
        font-size: 0.9rem;
        margin: 0;
    }
    
    .modal-close {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #718096;
        padding: 0.5rem;
        transition: color 0.2s;
    }
    
    .modal-close:hover {
        color: #f56565;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .order-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .detail-section {
        background: #f7fafc;
        padding: 1.25rem;
        border-radius: 8px;
    }
    
    .detail-section.full-width {
        grid-column: 1 / -1;
    }
    
    .detail-section h3 {
        font-size: 1.1rem;
        color: #2d3748;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }
    
    .detail-label {
        color: #718096;
        font-weight: 500;
    }
    
    .products-detail-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
    }
    
    .products-detail-table thead {
        background: white;
    }
    
    .products-detail-table th {
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.85rem;
        color: #2d3748;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .products-detail-table td {
        padding: 0.75rem;
        font-size: 0.9rem;
        color: #2d3748;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .order-total {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #e2e8f0;
        font-size: 1.1rem;
    }
    
    .total-value {
        color: #48bb78;
        font-weight: 700;
        font-size: 1.25rem;
    }
</style>
{% endblock %}

